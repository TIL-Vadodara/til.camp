{"dependencies":[{"name":"/Volumes/Work/forks/til.camp/package.json","includedInParent":true,"mtime":1526468255000},{"name":"/Volumes/Work/forks/til.camp/.browserslistrc","includedInParent":true,"mtime":1524300285000},{"name":"/Volumes/Work/forks/til.camp/node_modules/@firebase/messaging/package.json","includedInParent":true,"mtime":1519337717000},{"name":"@firebase/util","loc":{"line":17,"column":29}},{"name":"../models/errors","loc":{"line":18,"column":19}},{"name":"../models/token-details-model","loc":{"line":19,"column":30}},{"name":"../models/vapid-details-model","loc":{"line":20,"column":30}},{"name":"../models/notification-permission","loc":{"line":21,"column":36}},{"name":"../models/iid-model","loc":{"line":22,"column":21}},{"name":"../helpers/array-buffer-to-base64","loc":{"line":23,"column":32}}],"generated":{"js":"\"use strict\";Object.defineProperty(exports,\"__esModule\",{value:!0}),exports.TOKEN_EXPIRATION_MILLIS=void 0;var e=require(\"@firebase/util\"),t=require(\"../models/errors\"),o=p(t),n=require(\"../models/token-details-model\"),r=p(n),i=require(\"../models/vapid-details-model\"),s=p(i),a=require(\"../models/notification-permission\"),u=p(a),c=require(\"../models/iid-model\"),d=p(c),l=require(\"../helpers/array-buffer-to-base64\"),f=p(l);function p(e){return e&&e.__esModule?e:{default:e}}var h=\"messagingSenderId\",_=exports.TOKEN_EXPIRATION_MILLIS=6048e5,g=function(){function t(t){var n=this;if(this.errorFactory_=new e.ErrorFactory(\"messaging\",\"Messaging\",o.default.map),!t.options[h]||\"string\"!=typeof t.options[h])throw this.errorFactory_.create(o.default.codes.BAD_SENDER_ID);this.messagingSenderId_=t.options[h],this.tokenDetailsModel_=new r.default,this.vapidDetailsModel_=new s.default,this.iidModel_=new d.default,this.app=t,this.INTERNAL={},this.INTERNAL.delete=function(){return n.delete()}}return t.prototype.getToken=function(){var e,t=this,n=this.getNotificationPermission_();return n!==u.default.granted?n===u.default.denied?Promise.reject(this.errorFactory_.create(o.default.codes.NOTIFICATIONS_BLOCKED)):Promise.resolve(null):this.getSWRegistration_().then(function(o){return e=o,t.tokenDetailsModel_.getTokenDetailsFromSWScope(e.scope)}).then(function(o){return o?t.manageExistingToken(o,e):t.getNewToken(e)})},t.prototype.manageExistingToken=function(e,t){var o=this;return this.isTokenStillValid(e).then(function(n){return n?Date.now()<e.createTime+_?e.fcmToken:o.updateToken(e,t):o.deleteToken(e.fcmToken).then(function(){return o.getNewToken(t)})})},t.prototype.isTokenStillValid=function(e){return this.getPublicVapidKey_().then(function(t){return(0,f.default)(t)===e.vapidKey})},t.prototype.updateToken=function(e,t){var o,n,r,i=this;return this.getPublicVapidKey_().then(function(e){return o=e,i.getPushSubscription_(t,o)}).then(function(t){return r=t,i.iidModel_.updateToken(i.messagingSenderId_,e.fcmToken,e.fcmPushSet,r,o)}).catch(function(t){return i.deleteToken(e.fcmToken).then(function(){throw t})}).then(function(s){n=s;var a={swScope:t.scope,vapidKey:o,subscription:r,fcmSenderId:i.messagingSenderId_,fcmToken:n,fcmPushSet:e.fcmPushSet};return i.tokenDetailsModel_.saveTokenDetails(a)}).then(function(){return i.vapidDetailsModel_.saveVapidDetails(t.scope,o)}).then(function(){return n})},t.prototype.getNewToken=function(e){var t,o,n,r=this;return this.getPublicVapidKey_().then(function(o){return t=o,r.getPushSubscription_(e,t)}).then(function(e){return o=e,r.iidModel_.getToken(r.messagingSenderId_,o,t)}).then(function(i){n=i;var s={swScope:e.scope,vapidKey:t,subscription:o,fcmSenderId:r.messagingSenderId_,fcmToken:n.token,fcmPushSet:n.pushSet};return r.tokenDetailsModel_.saveTokenDetails(s)}).then(function(){return r.vapidDetailsModel_.saveVapidDetails(e.scope,t)}).then(function(){return n.token})},t.prototype.deleteToken=function(e){var t=this;return this.tokenDetailsModel_.deleteToken(e).then(function(e){return t.iidModel_.deleteToken(e.fcmSenderId,e.fcmToken,e.fcmPushSet)}).then(function(){return t.getSWRegistration_().then(function(e){if(e)return e.pushManager.getSubscription()}).then(function(e){if(e)return e.unsubscribe()})})},t.prototype.getSWRegistration_=function(){throw this.errorFactory_.create(o.default.codes.SHOULD_BE_INHERITED)},t.prototype.getPublicVapidKey_=function(){throw this.errorFactory_.create(o.default.codes.SHOULD_BE_INHERITED)},t.prototype.requestPermission=function(){throw this.errorFactory_.create(o.default.codes.AVAILABLE_IN_WINDOW)},t.prototype.getPushSubscription_=function(e,t){throw this.errorFactory_.create(o.default.codes.AVAILABLE_IN_WINDOW)},t.prototype.useServiceWorker=function(e){throw this.errorFactory_.create(o.default.codes.AVAILABLE_IN_WINDOW)},t.prototype.usePublicVapidKey=function(e){throw this.errorFactory_.create(o.default.codes.AVAILABLE_IN_WINDOW)},t.prototype.onMessage=function(e,t,n){throw this.errorFactory_.create(o.default.codes.AVAILABLE_IN_WINDOW)},t.prototype.onTokenRefresh=function(e,t,n){throw this.errorFactory_.create(o.default.codes.AVAILABLE_IN_WINDOW)},t.prototype.setBackgroundMessageHandler=function(e){throw this.errorFactory_.create(o.default.codes.AVAILABLE_IN_SW)},t.prototype.delete=function(){return Promise.all([this.tokenDetailsModel_.closeDatabase(),this.vapidDetailsModel_.closeDatabase()])},t.prototype.getNotificationPermission_=function(){return Notification.permission},t.prototype.getTokenDetailsModel=function(){return this.tokenDetailsModel_},t.prototype.getVapidDetailsModel=function(){return this.vapidDetailsModel_},t.prototype.getIIDModel=function(){return this.iidModel_},t}();exports.default=g;"},"hash":"699ae164f5725bb95553d704b255cc05","cacheData":{"env":{}}}