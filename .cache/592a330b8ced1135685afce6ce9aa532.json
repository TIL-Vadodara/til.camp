{"dependencies":[{"name":"/Volumes/Work/forks/til.camp/package.json","includedInParent":true,"mtime":1526468255000},{"name":"/Volumes/Work/forks/til.camp/.browserslistrc","includedInParent":true,"mtime":1524300285000},{"name":"/Volumes/Work/forks/til.camp/node_modules/@firebase/database/package.json","includedInParent":true,"mtime":1519337717000},{"name":"@firebase/util","loc":{"line":27,"column":21}},{"name":"../api/Reference","loc":{"line":19,"column":26}},{"name":"../api/DataSnapshot","loc":{"line":20,"column":29}},{"name":"./util/Path","loc":{"line":21,"column":21}},{"name":"./util/Tree","loc":{"line":22,"column":21}},{"name":"./snap/indexes/PriorityIndex","loc":{"line":23,"column":30}},{"name":"./util/util","loc":{"line":24,"column":21}},{"name":"./util/ServerValues","loc":{"line":25,"column":29}},{"name":"./util/validation","loc":{"line":26,"column":27}},{"name":"./snap/nodeFromJSON","loc":{"line":28,"column":29}},{"name":"./snap/ChildrenNode","loc":{"line":29,"column":29}},{"name":"./Repo","loc":{"line":30,"column":21}}],"generated":{"js":"\"use strict\";Object.defineProperty(exports,\"__esModule\",{value:!0});var e,t=require(\"@firebase/util\"),r=require(\"../api/Reference\"),n=require(\"../api/DataSnapshot\"),a=require(\"./util/Path\"),o=require(\"./util/Tree\"),s=require(\"./snap/indexes/PriorityIndex\"),u=require(\"./util/util\"),i=require(\"./util/ServerValues\"),l=require(\"./util/validation\"),c=require(\"@firebase/util\"),p=require(\"./snap/nodeFromJSON\"),h=require(\"./snap/ChildrenNode\"),d=require(\"./Repo\");!function(e){e[e.RUN=0]=\"RUN\",e[e.SENT=1]=\"SENT\",e[e.COMPLETED=2]=\"COMPLETED\",e[e.SENT_NEEDS_ABORT=3]=\"SENT_NEEDS_ABORT\",e[e.NEEDS_ABORT=4]=\"NEEDS_ABORT\"}(e=exports.TransactionStatus||(exports.TransactionStatus={})),d.Repo.MAX_TRANSACTION_RETRIES_=25,d.Repo.prototype.transactions_init_=function(){this.transactionQueueTree_=new o.Tree},d.Repo.prototype.startTransaction=function(a,o,d,T){this.log_(\"transaction on \"+a);var _=function(){},v=new r.Reference(this,a);v.on(\"value\",_);var f={path:a,update:o,onComplete:d,status:null,order:u.LUIDGenerator(),applyLocally:T,retryCount:0,unwatcher:function(){v.off(\"value\",_)},abortReason:null,currentWriteId:null,currentInputSnapshot:null,currentOutputSnapshotRaw:null,currentOutputSnapshotResolved:null},S=this.getLatestState_(a);f.currentInputSnapshot=S;var R=f.update(S.val());if(void 0===R){if(f.unwatcher(),f.currentOutputSnapshotRaw=null,f.currentOutputSnapshotResolved=null,f.onComplete){var E=new n.DataSnapshot(f.currentInputSnapshot,new r.Reference(this,f.path),s.PRIORITY_INDEX);f.onComplete(null,!1,E)}}else{l.validateFirebaseData(\"transaction failed: Data returned \",R,f.path),f.status=e.RUN;var N=this.transactionQueueTree_.subTree(a),g=N.getValue()||[];g.push(f),N.setValue(g);var y=void 0;if(\"object\"==typeof R&&null!==R&&c.contains(R,\".priority\"))y=c.safeGet(R,\".priority\"),t.assert(l.isValidPriority(y),\"Invalid priority returned by transaction. Priority must be a valid string, finite number, server value, or null.\");else y=(this.serverSyncTree_.calcCompleteEventCache(a)||h.ChildrenNode.EMPTY_NODE).getPriority().val();y=y;var O=this.generateServerValues(),C=p.nodeFromJSON(R,y),I=i.resolveDeferredValueSnapshot(C,O);f.currentOutputSnapshotRaw=C,f.currentOutputSnapshotResolved=I,f.currentWriteId=this.getNextWriteId_();var b=this.serverSyncTree_.applyUserOverwrite(a,I,f.currentWriteId,f.applyLocally);this.eventQueue_.raiseEventsForChangedPath(a,b),this.sendReadyTransactions_()}},d.Repo.prototype.getLatestState_=function(e,t){return this.serverSyncTree_.calcCompleteEventCache(e,t)||h.ChildrenNode.EMPTY_NODE},d.Repo.prototype.sendReadyTransactions_=function(r){var n=this;if(void 0===r&&(r=this.transactionQueueTree_),r||this.pruneCompletedTransactionsBelowNode_(r),null!==r.getValue()){var a=this.buildTransactionQueue_(r);t.assert(a.length>0,\"Sending zero length transaction queue\"),a.every(function(t){return t.status===e.RUN})&&this.sendTransactionQueue_(r.path(),a)}else r.hasChildren()&&r.forEachChild(function(e){n.sendReadyTransactions_(e)})},d.Repo.prototype.sendTransactionQueue_=function(o,i){for(var l=this,c=i.map(function(e){return e.currentWriteId}),p=this.getLatestState_(o,c),h=p,d=p.hash(),T=0;T<i.length;T++){var _=i[T];t.assert(_.status===e.RUN,\"tryToSendTransactionQueue_: items in queue should all be run.\"),_.status=e.SENT,_.retryCount++;var v=a.Path.relativePath(o,_.path);h=h.updateChild(v,_.currentOutputSnapshotRaw)}var f=h.val(!0),S=o;this.server_.put(S.toString(),f,function(t){l.log_(\"transaction put response\",{path:S.toString(),status:t});var a=[];if(\"ok\"===t){for(var c=[],p=0;p<i.length;p++){if(i[p].status=e.COMPLETED,a=a.concat(l.serverSyncTree_.ackUserWrite(i[p].currentWriteId)),i[p].onComplete){var h=i[p].currentOutputSnapshotResolved,d=new r.Reference(l,i[p].path),T=new n.DataSnapshot(h,d,s.PRIORITY_INDEX);c.push(i[p].onComplete.bind(null,null,!0,T))}i[p].unwatcher()}l.pruneCompletedTransactionsBelowNode_(l.transactionQueueTree_.subTree(o)),l.sendReadyTransactions_(),l.eventQueue_.raiseEventsForChangedPath(o,a);for(p=0;p<c.length;p++)u.exceptionGuard(c[p])}else{if(\"datastale\"===t)for(p=0;p<i.length;p++)i[p].status===e.SENT_NEEDS_ABORT?i[p].status=e.NEEDS_ABORT:i[p].status=e.RUN;else{u.warn(\"transaction at \"+S.toString()+\" failed: \"+t);for(p=0;p<i.length;p++)i[p].status=e.NEEDS_ABORT,i[p].abortReason=t}l.rerunTransactions_(o)}},d)},d.Repo.prototype.rerunTransactions_=function(e){var t=this.getAncestorTransactionNode_(e),r=t.path(),n=this.buildTransactionQueue_(t);return this.rerunTransactionQueue_(n,r),r},d.Repo.prototype.rerunTransactionQueue_=function(o,h){if(0!==o.length){for(var T,_=[],v=[],f=o.filter(function(t){return t.status===e.RUN}).map(function(e){return e.currentWriteId}),S=0;S<o.length;S++){var R=o[S],E=a.Path.relativePath(h,R.path),N=!1,g=void 0;if(t.assert(null!==E,\"rerunTransactionsUnderNode_: relativePath should not be null.\"),R.status===e.NEEDS_ABORT)N=!0,g=R.abortReason,v=v.concat(this.serverSyncTree_.ackUserWrite(R.currentWriteId,!0));else if(R.status===e.RUN)if(R.retryCount>=d.Repo.MAX_TRANSACTION_RETRIES_)N=!0,g=\"maxretry\",v=v.concat(this.serverSyncTree_.ackUserWrite(R.currentWriteId,!0));else{var y=this.getLatestState_(R.path,f);R.currentInputSnapshot=y;var O=o[S].update(y.val());if(void 0!==O){l.validateFirebaseData(\"transaction failed: Data returned \",O,R.path);var C=p.nodeFromJSON(O);\"object\"==typeof O&&null!=O&&c.contains(O,\".priority\")||(C=C.updatePriority(y.getPriority()));var I=R.currentWriteId,b=this.generateServerValues(),D=i.resolveDeferredValueSnapshot(C,b);R.currentOutputSnapshotRaw=C,R.currentOutputSnapshotResolved=D,R.currentWriteId=this.getNextWriteId_(),f.splice(f.indexOf(I),1),v=(v=v.concat(this.serverSyncTree_.applyUserOverwrite(R.path,D,R.currentWriteId,R.applyLocally))).concat(this.serverSyncTree_.ackUserWrite(I,!0))}else N=!0,g=\"nodata\",v=v.concat(this.serverSyncTree_.ackUserWrite(R.currentWriteId,!0))}if(this.eventQueue_.raiseEventsForChangedPath(h,v),v=[],N&&(o[S].status=e.COMPLETED,T=o[S].unwatcher,setTimeout(T,Math.floor(0)),o[S].onComplete))if(\"nodata\"===g){var m=new r.Reference(this,o[S].path),w=o[S].currentInputSnapshot,P=new n.DataSnapshot(w,m,s.PRIORITY_INDEX);_.push(o[S].onComplete.bind(null,null,!1,P))}else _.push(o[S].onComplete.bind(null,new Error(g),!1,null))}this.pruneCompletedTransactionsBelowNode_(this.transactionQueueTree_);for(S=0;S<_.length;S++)u.exceptionGuard(_[S]);this.sendReadyTransactions_()}},d.Repo.prototype.getAncestorTransactionNode_=function(e){for(var t,r=this.transactionQueueTree_;null!==(t=e.getFront())&&null===r.getValue();)r=r.subTree(t),e=e.popFront();return r},d.Repo.prototype.buildTransactionQueue_=function(e){var t=[];return this.aggregateTransactionQueuesForNode_(e,t),t.sort(function(e,t){return e.order-t.order}),t},d.Repo.prototype.aggregateTransactionQueuesForNode_=function(e,t){var r=this,n=e.getValue();if(null!==n)for(var a=0;a<n.length;a++)t.push(n[a]);e.forEachChild(function(e){r.aggregateTransactionQueuesForNode_(e,t)})},d.Repo.prototype.pruneCompletedTransactionsBelowNode_=function(t){var r=this,n=t.getValue();if(n){for(var a=0,o=0;o<n.length;o++)n[o].status!==e.COMPLETED&&(n[a]=n[o],a++);n.length=a,t.setValue(n.length>0?n:null)}t.forEachChild(function(e){r.pruneCompletedTransactionsBelowNode_(e)})},d.Repo.prototype.abortTransactions_=function(e){var t=this,r=this.getAncestorTransactionNode_(e).path(),n=this.transactionQueueTree_.subTree(e);return n.forEachAncestor(function(e){t.abortTransactionsOnNode_(e)}),this.abortTransactionsOnNode_(n),n.forEachDescendant(function(e){t.abortTransactionsOnNode_(e)}),r},d.Repo.prototype.abortTransactionsOnNode_=function(r){var n=r.getValue();if(null!==n){for(var a=[],o=[],s=-1,i=0;i<n.length;i++)if(n[i].status===e.SENT_NEEDS_ABORT);else if(n[i].status===e.SENT)t.assert(s===i-1,\"All SENT items should be at beginning of queue.\"),s=i,n[i].status=e.SENT_NEEDS_ABORT,n[i].abortReason=\"set\";else if(t.assert(n[i].status===e.RUN,\"Unexpected transaction status in abort\"),n[i].unwatcher(),o=o.concat(this.serverSyncTree_.ackUserWrite(n[i].currentWriteId,!0)),n[i].onComplete){a.push(n[i].onComplete.bind(null,new Error(\"set\"),!1,null))}-1===s?r.setValue(null):n.length=s+1,this.eventQueue_.raiseEventsForChangedPath(r.path(),o);for(i=0;i<a.length;i++)u.exceptionGuard(a[i])}};"},"hash":"52c6091b3986ddf53c50f5116060d62c","cacheData":{"env":{}}}