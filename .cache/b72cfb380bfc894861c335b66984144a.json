{"dependencies":[{"name":"/Volumes/Work/forks/til.camp/package.json","includedInParent":true,"mtime":1526468255000},{"name":"/Volumes/Work/forks/til.camp/.browserslistrc","includedInParent":true,"mtime":1524300285000},{"name":"/Volumes/Work/forks/til.camp/node_modules/@firebase/database/package.json","includedInParent":true,"mtime":1519337717000},{"name":"./util/ServerValues","loc":{"line":18,"column":29}},{"name":"./snap/nodeFromJSON","loc":{"line":19,"column":29}},{"name":"./util/Path","loc":{"line":20,"column":21}},{"name":"./SparseSnapshotTree","loc":{"line":21,"column":35}},{"name":"./SyncTree","loc":{"line":22,"column":25}},{"name":"./SnapshotHolder","loc":{"line":23,"column":31}},{"name":"@firebase/util","loc":{"line":26,"column":21}},{"name":"./util/util","loc":{"line":25,"column":21}},{"name":"./AuthTokenProvider","loc":{"line":27,"column":34}},{"name":"./stats/StatsManager","loc":{"line":28,"column":29}},{"name":"./stats/StatsReporter","loc":{"line":29,"column":30}},{"name":"./stats/StatsListener","loc":{"line":30,"column":30}},{"name":"./view/EventQueue","loc":{"line":31,"column":27}},{"name":"./PersistentConnection","loc":{"line":32,"column":37}},{"name":"./ReadonlyRestClient","loc":{"line":33,"column":35}},{"name":"../api/Database","loc":{"line":34,"column":25}}],"generated":{"js":"\"use strict\";Object.defineProperty(exports,\"__esModule\",{value:!0});var e=require(\"./util/ServerValues\"),t=require(\"./snap/nodeFromJSON\"),n=require(\"./util/Path\"),r=require(\"./SparseSnapshotTree\"),i=require(\"./SyncTree\"),o=require(\"./SnapshotHolder\"),a=require(\"@firebase/util\"),s=require(\"./util/util\"),c=require(\"@firebase/util\"),u=require(\"./AuthTokenProvider\"),h=require(\"./stats/StatsManager\"),p=require(\"./stats/StatsReporter\"),v=require(\"./stats/StatsListener\"),l=require(\"./view/EventQueue\"),_=require(\"./PersistentConnection\"),f=require(\"./ReadonlyRestClient\"),d=require(\"../api/Database\"),y=\"repo_interrupt\",S=function(){function S(e,t,n){var c=this;this.repoInfo_=e,this.app=n,this.dataUpdateCount=0,this.statsListener_=null,this.eventQueue_=new l.EventQueue,this.nextWriteId_=1,this.interceptServerDataCallback_=null,this.onDisconnect_=new r.SparseSnapshotTree,this.persistentConnection_=null;var v=new u.AuthTokenProvider(n);if(this.stats_=h.StatsManager.getCollection(e),t||s.beingCrawled())this.server_=new f.ReadonlyRestClient(this.repoInfo_,this.onDataUpdate_.bind(this),v),setTimeout(this.onConnectStatus_.bind(this,!0),0);else{var d=n.options.databaseAuthVariableOverride;if(null!=d){if(\"object\"!=typeof d)throw new Error(\"Only objects are supported for option databaseAuthVariableOverride\");try{a.stringify(d)}catch(e){throw new Error(\"Invalid authOverride provided: \"+e)}}this.persistentConnection_=new _.PersistentConnection(this.repoInfo_,this.onDataUpdate_.bind(this),this.onConnectStatus_.bind(this),this.onServerInfoUpdate_.bind(this),v,d),this.server_=this.persistentConnection_}v.addTokenChangeListener(function(e){c.server_.refreshAuthToken(e)}),this.statsReporter_=h.StatsManager.getOrCreateReporter(e,function(){return new p.StatsReporter(c.stats_,c.server_)}),this.transactions_init_(),this.infoData_=new o.SnapshotHolder,this.infoSyncTree_=new i.SyncTree({startListening:function(e,t,n,r){var i=[],o=c.infoData_.getNode(e.path);return o.isEmpty()||(i=c.infoSyncTree_.applyServerOverwrite(e.path,o),setTimeout(function(){r(\"ok\")},0)),i},stopListening:function(){}}),this.updateInfo_(\"connected\",!1),this.serverSyncTree_=new i.SyncTree({startListening:function(e,t,n,r){return c.server_.listen(e,n,t,function(t,n){var i=r(t,n);c.eventQueue_.raiseEventsForChangedPath(e.path,i)}),[]},stopListening:function(e,t){c.server_.unlisten(e,t)}})}return S.prototype.toString=function(){return(this.repoInfo_.secure?\"https://\":\"http://\")+this.repoInfo_.host},S.prototype.name=function(){return this.repoInfo_.namespace},S.prototype.serverTime=function(){var e=this.infoData_.getNode(new n.Path(\".info/serverTimeOffset\")).val()||0;return(new Date).getTime()+e},S.prototype.generateServerValues=function(){return e.generateWithValues({timestamp:this.serverTime()})},S.prototype.onDataUpdate_=function(e,r,i,o){this.dataUpdateCount++;var a=new n.Path(e);r=this.interceptServerDataCallback_?this.interceptServerDataCallback_(e,r):r;var s=[];if(o)if(i){var u=c.map(r,function(e){return t.nodeFromJSON(e)});s=this.serverSyncTree_.applyTaggedQueryMerge(a,u,o)}else{var h=t.nodeFromJSON(r);s=this.serverSyncTree_.applyTaggedQueryOverwrite(a,h,o)}else if(i){var p=c.map(r,function(e){return t.nodeFromJSON(e)});s=this.serverSyncTree_.applyServerMerge(a,p)}else{var v=t.nodeFromJSON(r);s=this.serverSyncTree_.applyServerOverwrite(a,v)}var l=a;s.length>0&&(l=this.rerunTransactions_(a)),this.eventQueue_.raiseEventsForChangedPath(l,s)},S.prototype.interceptServerData_=function(e){this.interceptServerDataCallback_=e},S.prototype.onConnectStatus_=function(e){this.updateInfo_(\"connected\",e),!1===e&&this.runOnDisconnectEvents_()},S.prototype.onServerInfoUpdate_=function(e){var t=this;s.each(e,function(e,n){t.updateInfo_(n,e)})},S.prototype.updateInfo_=function(e,r){var i=new n.Path(\"/.info/\"+e),o=t.nodeFromJSON(r);this.infoData_.updateSnapshot(i,o);var a=this.infoSyncTree_.applyServerOverwrite(i,o);this.eventQueue_.raiseEventsForChangedPath(i,a)},S.prototype.getNextWriteId_=function(){return this.nextWriteId_++},S.prototype.setWithPriority=function(n,r,i,o){var a=this;this.log_(\"set\",{path:n.toString(),value:r,priority:i});var c=this.generateServerValues(),u=t.nodeFromJSON(r,i),h=e.resolveDeferredValueSnapshot(u,c),p=this.getNextWriteId_(),v=this.serverSyncTree_.applyUserOverwrite(n,h,p,!0);this.eventQueue_.queueEvents(v),this.server_.put(n.toString(),u.val(!0),function(e,t){var r=\"ok\"===e;r||s.warn(\"set at \"+n+\" failed: \"+e);var i=a.serverSyncTree_.ackUserWrite(p,!r);a.eventQueue_.raiseEventsForChangedPath(n,i),a.callOnCompleteCallback(o,e,t)});var l=this.abortTransactions_(n);this.rerunTransactions_(l),this.eventQueue_.raiseEventsForChangedPath(l,[])},S.prototype.update=function(n,r,i){var o=this;this.log_(\"update\",{path:n.toString(),value:r});var a=!0,u=this.generateServerValues(),h={};if(c.forEach(r,function(n,r){a=!1;var i=t.nodeFromJSON(r);h[n]=e.resolveDeferredValueSnapshot(i,u)}),a)s.log(\"update() called with empty data.  Don't do anything.\"),this.callOnCompleteCallback(i,\"ok\");else{var p=this.getNextWriteId_(),v=this.serverSyncTree_.applyUserMerge(n,h,p);this.eventQueue_.queueEvents(v),this.server_.merge(n.toString(),r,function(e,t){var r=\"ok\"===e;r||s.warn(\"update at \"+n+\" failed: \"+e);var a=o.serverSyncTree_.ackUserWrite(p,!r),c=a.length>0?o.rerunTransactions_(n):n;o.eventQueue_.raiseEventsForChangedPath(c,a),o.callOnCompleteCallback(i,e,t)}),c.forEach(r,function(e){var t=o.abortTransactions_(n.child(e));o.rerunTransactions_(t)}),this.eventQueue_.raiseEventsForChangedPath(n,[])}},S.prototype.runOnDisconnectEvents_=function(){var t=this;this.log_(\"onDisconnectEvents\");var i=this.generateServerValues(),o=e.resolveDeferredValueTree(this.onDisconnect_,i),a=[];o.forEachTree(n.Path.Empty,function(e,n){a=a.concat(t.serverSyncTree_.applyServerOverwrite(e,n));var r=t.abortTransactions_(e);t.rerunTransactions_(r)}),this.onDisconnect_=new r.SparseSnapshotTree,this.eventQueue_.raiseEventsForChangedPath(n.Path.Empty,a)},S.prototype.onDisconnectCancel=function(e,t){var n=this;this.server_.onDisconnectCancel(e.toString(),function(r,i){\"ok\"===r&&n.onDisconnect_.forget(e),n.callOnCompleteCallback(t,r,i)})},S.prototype.onDisconnectSet=function(e,n,r){var i=this,o=t.nodeFromJSON(n);this.server_.onDisconnectPut(e.toString(),o.val(!0),function(t,n){\"ok\"===t&&i.onDisconnect_.remember(e,o),i.callOnCompleteCallback(r,t,n)})},S.prototype.onDisconnectSetWithPriority=function(e,n,r,i){var o=this,a=t.nodeFromJSON(n,r);this.server_.onDisconnectPut(e.toString(),a.val(!0),function(t,n){\"ok\"===t&&o.onDisconnect_.remember(e,a),o.callOnCompleteCallback(i,t,n)})},S.prototype.onDisconnectUpdate=function(e,n,r){var i=this;if(c.isEmpty(n))return s.log(\"onDisconnect().update() called with empty data.  Don't do anything.\"),void this.callOnCompleteCallback(r,\"ok\");this.server_.onDisconnectMerge(e.toString(),n,function(o,a){\"ok\"===o&&c.forEach(n,function(n,r){var o=t.nodeFromJSON(r);i.onDisconnect_.remember(e.child(n),o)}),i.callOnCompleteCallback(r,o,a)})},S.prototype.addEventCallbackForQuery=function(e,t){var n;n=\".info\"===e.path.getFront()?this.infoSyncTree_.addEventRegistration(e,t):this.serverSyncTree_.addEventRegistration(e,t),this.eventQueue_.raiseEventsAtPath(e.path,n)},S.prototype.removeEventCallbackForQuery=function(e,t){var n;n=\".info\"===e.path.getFront()?this.infoSyncTree_.removeEventRegistration(e,t):this.serverSyncTree_.removeEventRegistration(e,t),this.eventQueue_.raiseEventsAtPath(e.path,n)},S.prototype.interrupt=function(){this.persistentConnection_&&this.persistentConnection_.interrupt(y)},S.prototype.resume=function(){this.persistentConnection_&&this.persistentConnection_.resume(y)},S.prototype.stats=function(e){if(void 0===e&&(e=!1),\"undefined\"!=typeof console){var t;e?(this.statsListener_||(this.statsListener_=new v.StatsListener(this.stats_)),t=this.statsListener_.get()):t=this.stats_.get();var n=Object.keys(t).reduce(function(e,t){return Math.max(t.length,e)},0);c.forEach(t,function(e,t){for(var r=e.length;r<n+2;r++)e+=\" \";console.log(e+t)})}},S.prototype.statsIncrementCounter=function(e){this.stats_.incrementCounter(e),this.statsReporter_.includeStat(e)},S.prototype.log_=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=\"\";this.persistentConnection_&&(n=this.persistentConnection_.id+\":\"),s.log.apply(void 0,[n].concat(e))},S.prototype.callOnCompleteCallback=function(e,t,n){e&&s.exceptionGuard(function(){if(\"ok\"==t)e(null);else{var r=(t||\"error\").toUpperCase(),i=r;n&&(i+=\": \"+n);var o=new Error(i);o.code=r,e(o)}})},Object.defineProperty(S.prototype,\"database\",{get:function(){return this.__database||(this.__database=new d.Database(this))},enumerable:!0,configurable:!0}),S}();exports.Repo=S;"},"hash":"97c943f01bf19754cdc5b848511c4ae7","cacheData":{"env":{}}}