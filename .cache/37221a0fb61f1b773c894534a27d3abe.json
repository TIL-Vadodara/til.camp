{"dependencies":[{"name":"/Volumes/Work/forks/til.camp/package.json","includedInParent":true,"mtime":1526468255000},{"name":"/Volumes/Work/forks/til.camp/.browserslistrc","includedInParent":true,"mtime":1524300285000},{"name":"/Volumes/Work/forks/til.camp/node_modules/@firebase/database/package.json","includedInParent":true,"mtime":1519337717000},{"name":"tslib","loc":{"line":18,"column":22}},{"name":"@firebase/app","loc":{"line":19,"column":20}},{"name":"@firebase/util","loc":{"line":30,"column":21}},{"name":"./util/util","loc":{"line":23,"column":21}},{"name":"./util/Path","loc":{"line":24,"column":21}},{"name":"./util/VisibilityMonitor","loc":{"line":25,"column":34}},{"name":"./util/OnlineMonitor","loc":{"line":26,"column":30}},{"name":"../realtime/Connection","loc":{"line":28,"column":27}},{"name":"./ServerActions","loc":{"line":31,"column":30}}],"generated":{"js":"\"use strict\";Object.defineProperty(exports,\"__esModule\",{value:!0});var t=require(\"tslib\"),e=require(\"@firebase/app\"),n=require(\"@firebase/util\"),i=require(\"@firebase/util\"),o=require(\"@firebase/util\"),s=require(\"./util/util\"),r=require(\"./util/Path\"),a=require(\"./util/VisibilityMonitor\"),c=require(\"./util/OnlineMonitor\"),u=require(\"@firebase/util\"),l=require(\"../realtime/Connection\"),h=require(\"@firebase/util\"),_=require(\"@firebase/util\"),d=require(\"./ServerActions\"),p=1e3,f=3e5,g=3e4,m=1.3,y=3e4,v=\"server_kill\",C=3,T=function(d){function T(t,e,n,i,o,r){var u=d.call(this)||this;if(u.repoInfo_=t,u.onDataUpdate_=e,u.onConnectStatus_=n,u.onServerInfoUpdate_=i,u.authTokenProvider_=o,u.authOverride_=r,u.id=T.nextPersistentConnectionId_++,u.log_=s.logWrapper(\"p:\"+u.id+\":\"),u.interruptReasons_={},u.listens_={},u.outstandingPuts_=[],u.outstandingPutCount_=0,u.onDisconnectRequestQueue_=[],u.connected_=!1,u.reconnectDelay_=p,u.maxReconnectDelay_=f,u.securityDebugCallback_=null,u.lastSessionId=null,u.establishConnectionTimer_=null,u.visible_=!1,u.requestCBHash_={},u.requestNumber_=0,u.realtime_=null,u.authToken_=null,u.forceTokenRefresh_=!1,u.invalidAuthTokenCount_=0,u.firstConnection_=!0,u.lastConnectionAttemptTime_=null,u.lastConnectionEstablishedTime_=null,r&&!_.isNodeSdk())throw new Error(\"Auth override specified in options, but not supported on non Node.js platforms\");return u.scheduleConnect_(0),a.VisibilityMonitor.getInstance().on(\"visible\",u.onVisible_,u),-1===t.host.indexOf(\"fblocal\")&&c.OnlineMonitor.getInstance().on(\"online\",u.onOnline_,u),u}return t.__extends(T,d),T.prototype.sendRequest=function(t,e,n){var s=++this.requestNumber_,r={r:s,a:t,b:e};this.log_(i.stringify(r)),o.assert(this.connected_,\"sendRequest call when we're not connected not allowed.\"),this.realtime_.sendRequest(r),n&&(this.requestCBHash_[s]=n)},T.prototype.listen=function(t,e,n,i){var s=t.queryIdentifier(),r=t.path.toString();this.log_(\"Listen called for \"+r+\" \"+s),this.listens_[r]=this.listens_[r]||{},o.assert(t.getQueryParams().isDefault()||!t.getQueryParams().loadsAllData(),\"listen() called for non-default but complete query\"),o.assert(!this.listens_[r][s],\"listen() called twice for same path/queryId.\");var a={onComplete:i,hashFn:e,query:t,tag:n};this.listens_[r][s]=a,this.connected_&&this.sendListen_(a)},T.prototype.sendListen_=function(t){var e=this,n=t.query,i=n.path.toString(),o=n.queryIdentifier();this.log_(\"Listen on \"+i+\" for \"+o);var s={p:i};t.tag&&(s.q=n.queryObject(),s.t=t.tag),s.h=t.hashFn(),this.sendRequest(\"q\",s,function(s){var r=s.d,a=s.s;T.warnOnListenWarnings_(r,n),(e.listens_[i]&&e.listens_[i][o])===t&&(e.log_(\"listen response\",s),\"ok\"!==a&&e.removeListen_(i,o),t.onComplete&&t.onComplete(a,r))})},T.warnOnListenWarnings_=function(t,e){if(t&&\"object\"==typeof t&&n.contains(t,\"w\")){var i=n.safeGet(t,\"w\");if(Array.isArray(i)&&~i.indexOf(\"no_index\")){var o='\".indexOn\": \"'+e.getQueryParams().getIndex().toString()+'\"',r=e.path.toString();s.warn(\"Using an unspecified index. Your data will be downloaded and filtered on the client. Consider adding \"+o+\" at \"+r+\" to your security rules for better performance.\")}}},T.prototype.refreshAuthToken=function(t){this.authToken_=t,this.log_(\"Auth token refreshed\"),this.authToken_?this.tryAuth():this.connected_&&this.sendRequest(\"unauth\",{},function(){}),this.reduceReconnectDelayIfAdminCredential_(t)},T.prototype.reduceReconnectDelayIfAdminCredential_=function(t){(t&&40===t.length||u.isAdmin(t))&&(this.log_(\"Admin auth credential detected.  Reducing max reconnect time.\"),this.maxReconnectDelay_=g)},T.prototype.tryAuth=function(){var t=this;if(this.connected_&&this.authToken_){var e=this.authToken_,n=u.isValidFormat(e)?\"auth\":\"gauth\",i={cred:e};null===this.authOverride_?i.noauth=!0:\"object\"==typeof this.authOverride_&&(i.authvar=this.authOverride_),this.sendRequest(n,i,function(n){var i=n.s,o=n.d||\"error\";t.authToken_===e&&(\"ok\"===i?t.invalidAuthTokenCount_=0:t.onAuthRevoked_(i,o))})}},T.prototype.unlisten=function(t,e){var n=t.path.toString(),i=t.queryIdentifier();this.log_(\"Unlisten called for \"+n+\" \"+i),o.assert(t.getQueryParams().isDefault()||!t.getQueryParams().loadsAllData(),\"unlisten() called for non-default but complete query\"),this.removeListen_(n,i)&&this.connected_&&this.sendUnlisten_(n,i,t.queryObject(),e)},T.prototype.sendUnlisten_=function(t,e,n,i){this.log_(\"Unlisten on \"+t+\" for \"+e);var o={p:t};i&&(o.q=n,o.t=i),this.sendRequest(\"n\",o)},T.prototype.onDisconnectPut=function(t,e,n){this.connected_?this.sendOnDisconnect_(\"o\",t,e,n):this.onDisconnectRequestQueue_.push({pathString:t,action:\"o\",data:e,onComplete:n})},T.prototype.onDisconnectMerge=function(t,e,n){this.connected_?this.sendOnDisconnect_(\"om\",t,e,n):this.onDisconnectRequestQueue_.push({pathString:t,action:\"om\",data:e,onComplete:n})},T.prototype.onDisconnectCancel=function(t,e){this.connected_?this.sendOnDisconnect_(\"oc\",t,null,e):this.onDisconnectRequestQueue_.push({pathString:t,action:\"oc\",data:null,onComplete:e})},T.prototype.sendOnDisconnect_=function(t,e,n,i){var o={p:e,d:n};this.log_(\"onDisconnect \"+t,o),this.sendRequest(t,o,function(t){i&&setTimeout(function(){i(t.s,t.d)},Math.floor(0))})},T.prototype.put=function(t,e,n,i){this.putInternal(\"p\",t,e,n,i)},T.prototype.merge=function(t,e,n,i){this.putInternal(\"m\",t,e,n,i)},T.prototype.putInternal=function(t,e,n,i,o){var s={p:e,d:n};void 0!==o&&(s.h=o),this.outstandingPuts_.push({action:t,request:s,onComplete:i}),this.outstandingPutCount_++;var r=this.outstandingPuts_.length-1;this.connected_?this.sendPut_(r):this.log_(\"Buffering put: \"+e)},T.prototype.sendPut_=function(t){var e=this,n=this.outstandingPuts_[t].action,i=this.outstandingPuts_[t].request,o=this.outstandingPuts_[t].onComplete;this.outstandingPuts_[t].queued=this.connected_,this.sendRequest(n,i,function(i){e.log_(n+\" response\",i),delete e.outstandingPuts_[t],e.outstandingPutCount_--,0===e.outstandingPutCount_&&(e.outstandingPuts_=[]),o&&o(i.s,i.d)})},T.prototype.reportStats=function(t){var e=this;if(this.connected_){var n={c:t};this.log_(\"reportStats\",n),this.sendRequest(\"s\",n,function(t){if(\"ok\"!==t.s){var n=t.d;e.log_(\"reportStats\",\"Error sending stats: \"+n)}})}},T.prototype.onDataMessage_=function(t){if(\"r\"in t){this.log_(\"from server: \"+i.stringify(t));var e=t.r,n=this.requestCBHash_[e];n&&(delete this.requestCBHash_[e],n(t.b))}else{if(\"error\"in t)throw\"A server-side error has occurred: \"+t.error;\"a\"in t&&this.onDataPush_(t.a,t.b)}},T.prototype.onDataPush_=function(t,e){this.log_(\"handleServerMessage\",t,e),\"d\"===t?this.onDataUpdate_(e.p,e.d,!1,e.t):\"m\"===t?this.onDataUpdate_(e.p,e.d,!0,e.t):\"c\"===t?this.onListenRevoked_(e.p,e.q):\"ac\"===t?this.onAuthRevoked_(e.s,e.d):\"sd\"===t?this.onSecurityDebugPacket_(e):s.error(\"Unrecognized action received from server: \"+i.stringify(t)+\"\\nAre you using the latest client?\")},T.prototype.onReady_=function(t,e){this.log_(\"connection ready\"),this.connected_=!0,this.lastConnectionEstablishedTime_=(new Date).getTime(),this.handleTimestamp_(t),this.lastSessionId=e,this.firstConnection_&&this.sendConnectStats_(),this.restoreState_(),this.firstConnection_=!1,this.onConnectStatus_(!0)},T.prototype.scheduleConnect_=function(t){var e=this;o.assert(!this.realtime_,\"Scheduling a connect when we're already connected/ing?\"),this.establishConnectionTimer_&&clearTimeout(this.establishConnectionTimer_),this.establishConnectionTimer_=setTimeout(function(){e.establishConnectionTimer_=null,e.establishConnection_()},Math.floor(t))},T.prototype.onVisible_=function(t){t&&!this.visible_&&this.reconnectDelay_===this.maxReconnectDelay_&&(this.log_(\"Window became visible.  Reducing delay.\"),this.reconnectDelay_=p,this.realtime_||this.scheduleConnect_(0)),this.visible_=t},T.prototype.onOnline_=function(t){t?(this.log_(\"Browser went online.\"),this.reconnectDelay_=p,this.realtime_||this.scheduleConnect_(0)):(this.log_(\"Browser went offline.  Killing connection.\"),this.realtime_&&this.realtime_.close())},T.prototype.onRealtimeDisconnect_=function(){if(this.log_(\"data client disconnected\"),this.connected_=!1,this.realtime_=null,this.cancelSentTransactions_(),this.requestCBHash_={},this.shouldReconnect_()){if(this.visible_){if(this.lastConnectionEstablishedTime_){(new Date).getTime()-this.lastConnectionEstablishedTime_>y&&(this.reconnectDelay_=p),this.lastConnectionEstablishedTime_=null}}else this.log_(\"Window isn't visible.  Delaying reconnect.\"),this.reconnectDelay_=this.maxReconnectDelay_,this.lastConnectionAttemptTime_=(new Date).getTime();var t=(new Date).getTime()-this.lastConnectionAttemptTime_,e=Math.max(0,this.reconnectDelay_-t);e=Math.random()*e,this.log_(\"Trying to reconnect in \"+e+\"ms\"),this.scheduleConnect_(e),this.reconnectDelay_=Math.min(this.maxReconnectDelay_,this.reconnectDelay_*m)}this.onConnectStatus_(!1)},T.prototype.establishConnection_=function(){if(this.shouldReconnect_()){this.log_(\"Making a connection attempt\"),this.lastConnectionAttemptTime_=(new Date).getTime(),this.lastConnectionEstablishedTime_=null;var t=this.onDataMessage_.bind(this),e=this.onReady_.bind(this),n=this.onRealtimeDisconnect_.bind(this),i=this.id+\":\"+T.nextConnectionId_++,r=this,a=this.lastSessionId,c=!1,u=null,_=function(){u?u.close():(c=!0,n())};this.realtime_={close:_,sendRequest:function(t){o.assert(u,\"sendRequest call when we're not connected not allowed.\"),u.sendRequest(t)}};var d=this.forceTokenRefresh_;this.forceTokenRefresh_=!1,this.authTokenProvider_.getToken(d).then(function(o){c?s.log(\"getToken() completed but was canceled\"):(s.log(\"getToken() completed. Creating connection.\"),r.authToken_=o&&o.accessToken,u=new l.Connection(i,r.repoInfo_,t,e,n,function(t){s.warn(t+\" (\"+r.repoInfo_.toString()+\")\"),r.interrupt(v)},a))}).then(null,function(t){r.log_(\"Failed to get token: \"+t),c||(h.CONSTANTS.NODE_ADMIN&&s.warn(t),_())})}},T.prototype.interrupt=function(t){s.log(\"Interrupting connection for reason: \"+t),this.interruptReasons_[t]=!0,this.realtime_?this.realtime_.close():(this.establishConnectionTimer_&&(clearTimeout(this.establishConnectionTimer_),this.establishConnectionTimer_=null),this.connected_&&this.onRealtimeDisconnect_())},T.prototype.resume=function(t){s.log(\"Resuming connection for reason: \"+t),delete this.interruptReasons_[t],n.isEmpty(this.interruptReasons_)&&(this.reconnectDelay_=p,this.realtime_||this.scheduleConnect_(0))},T.prototype.handleTimestamp_=function(t){var e=t-(new Date).getTime();this.onServerInfoUpdate_({serverTimeOffset:e})},T.prototype.cancelSentTransactions_=function(){for(var t=0;t<this.outstandingPuts_.length;t++){var e=this.outstandingPuts_[t];e&&\"h\"in e.request&&e.queued&&(e.onComplete&&e.onComplete(\"disconnect\"),delete this.outstandingPuts_[t],this.outstandingPutCount_--)}0===this.outstandingPutCount_&&(this.outstandingPuts_=[])},T.prototype.onListenRevoked_=function(t,e){var n;n=e?e.map(function(t){return s.ObjectToUniqueKey(t)}).join(\"$\"):\"default\";var i=this.removeListen_(t,n);i&&i.onComplete&&i.onComplete(\"permission_denied\")},T.prototype.removeListen_=function(t,e){var i,o=new r.Path(t).toString();return void 0!==this.listens_[o]?(i=this.listens_[o][e],delete this.listens_[o][e],0===n.getCount(this.listens_[o])&&delete this.listens_[o]):i=void 0,i},T.prototype.onAuthRevoked_=function(t,e){s.log(\"Auth token revoked: \"+t+\"/\"+e),this.authToken_=null,this.forceTokenRefresh_=!0,this.realtime_.close(),\"invalid_token\"!==t&&\"permission_denied\"!==t||(this.invalidAuthTokenCount_++,this.invalidAuthTokenCount_>=C&&(this.reconnectDelay_=g,this.authTokenProvider_.notifyForInvalidToken()))},T.prototype.onSecurityDebugPacket_=function(t){this.securityDebugCallback_?this.securityDebugCallback_(t):\"msg\"in t&&\"undefined\"!=typeof console&&console.log(\"FIREBASE: \"+t.msg.replace(\"\\n\",\"\\nFIREBASE: \"))},T.prototype.restoreState_=function(){var t=this;this.tryAuth(),n.forEach(this.listens_,function(e,i){n.forEach(i,function(e,n){t.sendListen_(n)})});for(var e=0;e<this.outstandingPuts_.length;e++)this.outstandingPuts_[e]&&this.sendPut_(e);for(;this.onDisconnectRequestQueue_.length;){var i=this.onDisconnectRequestQueue_.shift();this.sendOnDisconnect_(i.action,i.pathString,i.data,i.onComplete)}},T.prototype.sendConnectStats_=function(){var t={},n=\"js\";h.CONSTANTS.NODE_ADMIN?n=\"admin_node\":h.CONSTANTS.NODE_CLIENT&&(n=\"node\"),t[\"sdk.\"+n+\".\"+e.default.SDK_VERSION.replace(/\\./g,\"-\")]=1,_.isMobileCordova()?t[\"framework.cordova\"]=1:_.isReactNative()&&(t[\"framework.reactnative\"]=1),this.reportStats(t)},T.prototype.shouldReconnect_=function(){var t=c.OnlineMonitor.getInstance().currentlyOnline();return n.isEmpty(this.interruptReasons_)&&t},T.nextPersistentConnectionId_=0,T.nextConnectionId_=0,T}(d.ServerActions);exports.PersistentConnection=T;"},"hash":"e329116c0b715657ee8f939ae60fde3d","cacheData":{"env":{}}}