{"dependencies":[{"name":"/Volumes/Work/forks/til.camp/package.json","includedInParent":true,"mtime":1526468255000},{"name":"/Volumes/Work/forks/til.camp/.browserslistrc","includedInParent":true,"mtime":1524300285000},{"name":"/Volumes/Work/forks/til.camp/node_modules/@firebase/messaging/package.json","includedInParent":true,"mtime":1519337717000},{"name":"tslib","loc":{"line":17,"column":25}},{"name":"./controller-interface","loc":{"line":18,"column":32}},{"name":"../models/errors","loc":{"line":19,"column":19}},{"name":"../models/fcm-details","loc":{"line":20,"column":23}},{"name":"../models/worker-page-message","loc":{"line":21,"column":30}}],"generated":{"js":"\"use strict\";Object.defineProperty(exports,\"__esModule\",{value:!0});var t=require(\"tslib\"),e=f(t),n=require(\"./controller-interface\"),i=l(n),o=require(\"../models/errors\"),r=l(o),a=require(\"../models/fcm-details\"),s=l(a),c=require(\"../models/worker-page-message\"),u=l(c);function l(t){return t&&t.__esModule?t:{default:t}}function f(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e.default=t,e}var d=\"FCM_MSG\",_=function(t){function n(e){var n=t.call(this,e)||this;return self.addEventListener(\"push\",function(t){return n.onPush_(t)},!1),self.addEventListener(\"pushsubscriptionchange\",function(t){return n.onSubChange_(t)},!1),self.addEventListener(\"notificationclick\",function(t){return n.onNotificationClick_(t)},!1),n.bgMessageHandler_=null,n}return e.__extends(n,t),n.prototype.onPush_=function(t){var e,n=this;try{e=t.data.json()}catch(t){return}var i=this.hasVisibleClients_().then(function(t){if(t)return e.notification||n.bgMessageHandler_?n.sendMessageToWindowClients_(e):void 0;var i=n.getNotificationData_(e);if(i){var o=i.title||\"\";return n.getSWRegistration_().then(function(t){return t.showNotification(o,i)})}return n.bgMessageHandler_?n.bgMessageHandler_(e):void 0});t.waitUntil(i)},n.prototype.onSubChange_=function(t){var e=this,n=this.getSWRegistration_().then(function(t){return t.pushManager.getSubscription().then(function(t){}).catch(function(n){return e.getTokenDetailsModel().getTokenDetailsFromSWScope(t.scope).then(function(t){if(!t)throw n;return e.deleteToken(t.fcmToken).then(function(){throw n})})})}).catch(function(t){throw e.errorFactory_.create(r.default.codes.UNABLE_TO_RESUBSCRIBE,{message:t})});t.waitUntil(n)},n.prototype.onNotificationClick_=function(t){var e=this;if(t.notification&&t.notification.data&&t.notification.data[d]){t.stopImmediatePropagation(),t.notification.close();var n=t.notification.data[d];if(n.notification){var i=n.notification.click_action;if(i){var o=this.getWindowClient_(i).then(function(t){return t?t.focus():self.clients.openWindow(i)}).then(function(t){if(t){n.notification;delete n.notification;var i=u.default.createNewMsg(u.default.TYPES_OF_MSG.NOTIFICATION_CLICKED,n);return e.attemptToMessageClient_(t,i)}});t.waitUntil(o)}}}},n.prototype.getNotificationData_=function(t){if(t&&\"object\"==typeof t.notification){var e,n=Object.assign({},t.notification);return n.data=((e={})[d]=t,e),n}},n.prototype.setBackgroundMessageHandler=function(t){if(!t||\"function\"!=typeof t)throw this.errorFactory_.create(r.default.codes.BG_HANDLER_FUNCTION_EXPECTED);this.bgMessageHandler_=t},n.prototype.getWindowClient_=function(t){var e=new URL(t,self.location).href;return self.clients.matchAll({type:\"window\",includeUncontrolled:!0}).then(function(t){for(var n=null,i=0;i<t.length;i++){if(new URL(t[i].url,self.location).href===e){n=t[i];break}}return n||null})},n.prototype.attemptToMessageClient_=function(t,n){return e.__awaiter(this,void 0,void 0,function(){return e.__generator(this,function(e){return t?(t.postMessage(n),[2]):[2,Promise.reject(this.errorFactory_.create(r.default.codes.NO_WINDOW_CLIENT_TO_MSG))]})})},n.prototype.hasVisibleClients_=function(){return self.clients.matchAll({type:\"window\",includeUncontrolled:!0}).then(function(t){return t.some(function(t){return\"visible\"===t.visibilityState})})},n.prototype.sendMessageToWindowClients_=function(t){var e=this;return self.clients.matchAll({type:\"window\",includeUncontrolled:!0}).then(function(n){var i=u.default.createNewMsg(u.default.TYPES_OF_MSG.PUSH_MSG_RECEIVED,t);return Promise.all(n.map(function(t){return e.attemptToMessageClient_(t,i)}))})},n.prototype.getSWRegistration_=function(){return Promise.resolve(self.registration)},n.prototype.getPublicVapidKey_=function(){var t=this;return this.getSWRegistration_().then(function(e){return t.getVapidDetailsModel().getVapidFromSWScope(e.scope)}).then(function(t){return null===t?s.default.DEFAULT_PUBLIC_VAPID_KEY:t})},n}(i.default);exports.default=_;"},"hash":"e67f0a3ae8687884923959098dd7be45","cacheData":{"env":{}}}