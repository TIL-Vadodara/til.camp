{"dependencies":[{"name":"/Volumes/Work/forks/til.camp/package.json","includedInParent":true,"mtime":1526468255000},{"name":"/Volumes/Work/forks/til.camp/.browserslistrc","includedInParent":true,"mtime":1524300285000},{"name":"/Volumes/Work/forks/til.camp/node_modules/@firebase/database/package.json","includedInParent":true,"mtime":1519337717000},{"name":"@firebase/util","loc":{"line":22,"column":21}},{"name":"./util/util","loc":{"line":19,"column":21}},{"name":"./operation/AckUserWrite","loc":{"line":20,"column":29}},{"name":"./snap/ChildrenNode","loc":{"line":21,"column":29}},{"name":"./util/ImmutableTree","loc":{"line":23,"column":30}},{"name":"./operation/ListenComplete","loc":{"line":24,"column":31}},{"name":"./operation/Merge","loc":{"line":25,"column":22}},{"name":"./operation/Operation","loc":{"line":26,"column":26}},{"name":"./operation/Overwrite","loc":{"line":27,"column":26}},{"name":"./util/Path","loc":{"line":28,"column":21}},{"name":"./SyncPoint","loc":{"line":29,"column":26}},{"name":"./WriteTree","loc":{"line":30,"column":26}}],"generated":{"js":"\"use strict\";Object.defineProperty(exports,\"__esModule\",{value:!0});var e=require(\"@firebase/util\"),t=require(\"./util/util\"),r=require(\"./operation/AckUserWrite\"),i=require(\"./snap/ChildrenNode\"),n=require(\"@firebase/util\"),a=require(\"./util/ImmutableTree\"),o=require(\"./operation/ListenComplete\"),p=require(\"./operation/Merge\"),s=require(\"./operation/Operation\"),u=require(\"./operation/Overwrite\"),y=require(\"./util/Path\"),l=require(\"./SyncPoint\"),h=require(\"./WriteTree\"),c=function(){function c(e){this.listenProvider_=e,this.syncPointTree_=a.ImmutableTree.Empty,this.pendingWriteTree_=new h.WriteTree,this.tagToQueryMap_={},this.queryToTagMap_={}}return c.prototype.applyUserOverwrite=function(e,t,r,i){return this.pendingWriteTree_.addOverwrite(e,t,r,i),i?this.applyOperationToSyncPoints_(new u.Overwrite(s.OperationSource.User,e,t)):[]},c.prototype.applyUserMerge=function(e,t,r){this.pendingWriteTree_.addMerge(e,t,r);var i=a.ImmutableTree.fromObject(t);return this.applyOperationToSyncPoints_(new p.Merge(s.OperationSource.User,e,i))},c.prototype.ackUserWrite=function(e,t){void 0===t&&(t=!1);var i=this.pendingWriteTree_.getWrite(e);if(this.pendingWriteTree_.removeWrite(e)){var o=a.ImmutableTree.Empty;return null!=i.snap?o=o.set(y.Path.Empty,!0):n.forEach(i.children,function(e,t){o=o.set(new y.Path(e),t)}),this.applyOperationToSyncPoints_(new r.AckUserWrite(i.path,o,t))}return[]},c.prototype.applyServerOverwrite=function(e,t){return this.applyOperationToSyncPoints_(new u.Overwrite(s.OperationSource.Server,e,t))},c.prototype.applyServerMerge=function(e,t){var r=a.ImmutableTree.fromObject(t);return this.applyOperationToSyncPoints_(new p.Merge(s.OperationSource.Server,e,r))},c.prototype.applyListenComplete=function(e){return this.applyOperationToSyncPoints_(new o.ListenComplete(s.OperationSource.Server,e))},c.prototype.applyTaggedQueryOverwrite=function(e,t,r){var i=this.queryKeyForTag_(r);if(null!=i){var n=c.parseQueryKey_(i),a=n.path,o=n.queryId,p=y.Path.relativePath(a,e),l=new u.Overwrite(s.OperationSource.forServerTaggedQuery(o),p,t);return this.applyTaggedOperation_(a,l)}return[]},c.prototype.applyTaggedQueryMerge=function(e,t,r){var i=this.queryKeyForTag_(r);if(i){var n=c.parseQueryKey_(i),o=n.path,u=n.queryId,l=y.Path.relativePath(o,e),h=a.ImmutableTree.fromObject(t),g=new p.Merge(s.OperationSource.forServerTaggedQuery(u),l,h);return this.applyTaggedOperation_(o,g)}return[]},c.prototype.applyTaggedListenComplete=function(e,t){var r=this.queryKeyForTag_(t);if(r){var i=c.parseQueryKey_(r),n=i.path,a=i.queryId,p=y.Path.relativePath(n,e),u=new o.ListenComplete(s.OperationSource.forServerTaggedQuery(a),p);return this.applyTaggedOperation_(n,u)}return[]},c.prototype.addEventRegistration=function(t,r){var n=t.path,a=null,o=!1;this.syncPointTree_.foreachOnPath(n,function(e,t){var r=y.Path.relativePath(e,n);a=a||t.getCompleteServerCache(r),o=o||t.hasCompleteView()});var p,s=this.syncPointTree_.get(n);(s?(o=o||s.hasCompleteView(),a=a||s.getCompleteServerCache(y.Path.Empty)):(s=new l.SyncPoint,this.syncPointTree_=this.syncPointTree_.set(n,s)),null!=a)?p=!0:(p=!1,a=i.ChildrenNode.EMPTY_NODE,this.syncPointTree_.subtree(n).foreachChild(function(e,t){var r=t.getCompleteServerCache(y.Path.Empty);r&&(a=a.updateImmediateChild(e,r))}));var u=s.viewExistsForQuery(t);if(!u&&!t.getQueryParams().loadsAllData()){var h=c.makeQueryKey_(t);e.assert(!(h in this.queryToTagMap_),\"View does not exist, but we have a tag\");var g=c.getNextQueryTag_();this.queryToTagMap_[h]=g,this.tagToQueryMap_[\"_\"+g]=h}var v=this.pendingWriteTree_.childWrites(n),_=s.addEventRegistration(t,r,v,a,p);if(!u&&!o){var d=s.viewForQuery(t);_=_.concat(this.setupListener_(t,d))}return _},c.prototype.removeEventRegistration=function(e,t,r){var i=this,n=e.path,a=this.syncPointTree_.get(n),o=[];if(a&&(\"default\"===e.queryIdentifier()||a.viewExistsForQuery(e))){var p=a.removeEventRegistration(e,t,r);a.isEmpty()&&(this.syncPointTree_=this.syncPointTree_.remove(n));var s=p.removed;o=p.events;var u=-1!==s.findIndex(function(e){return e.getQueryParams().loadsAllData()}),y=this.syncPointTree_.findOnPath(n,function(e,t){return t.hasCompleteView()});if(u&&!y){var l=this.syncPointTree_.subtree(n);if(!l.isEmpty())for(var h=this.collectDistinctViewsForSubTree_(l),g=0;g<h.length;++g){var v=h[g],_=v.getQuery(),d=this.createListenerForView_(v);this.listenProvider_.startListening(c.queryForListening_(_),this.tagForQuery_(_),d.hashFn,d.onComplete)}}if(!y&&s.length>0&&!r)if(u){this.listenProvider_.stopListening(c.queryForListening_(e),null)}else s.forEach(function(e){var t=i.queryToTagMap_[c.makeQueryKey_(e)];i.listenProvider_.stopListening(c.queryForListening_(e),t)});this.removeTags_(s)}return o},c.prototype.calcCompleteEventCache=function(e,t){var r=this.pendingWriteTree_,i=this.syncPointTree_.findOnPath(e,function(t,r){var i=y.Path.relativePath(t,e),n=r.getCompleteServerCache(i);if(n)return n});return r.calcCompleteEventCache(e,i,t,!0)},c.prototype.collectDistinctViewsForSubTree_=function(e){return e.fold(function(e,t,r){if(t&&t.hasCompleteView())return[t.getCompleteView()];var i=[];return t&&(i=t.getQueryViews()),n.forEach(r,function(e,t){i=i.concat(t)}),i})},c.prototype.removeTags_=function(e){for(var t=0;t<e.length;++t){var r=e[t];if(!r.getQueryParams().loadsAllData()){var i=c.makeQueryKey_(r),n=this.queryToTagMap_[i];delete this.queryToTagMap_[i],delete this.tagToQueryMap_[\"_\"+n]}}},c.queryForListening_=function(e){return e.getQueryParams().loadsAllData()&&!e.getQueryParams().isDefault()?e.getRef():e},c.prototype.setupListener_=function(t,r){var i=t.path,a=this.tagForQuery_(t),o=this.createListenerForView_(r),p=this.listenProvider_.startListening(c.queryForListening_(t),a,o.hashFn,o.onComplete),s=this.syncPointTree_.subtree(i);if(a)e.assert(!s.value.hasCompleteView(),\"If we're adding a query, it shouldn't be shadowed\");else for(var u=s.fold(function(e,t,r){if(!e.isEmpty()&&t&&t.hasCompleteView())return[t.getCompleteView().getQuery()];var i=[];return t&&(i=i.concat(t.getQueryViews().map(function(e){return e.getQuery()}))),n.forEach(r,function(e,t){i=i.concat(t)}),i}),y=0;y<u.length;++y){var l=u[y];this.listenProvider_.stopListening(c.queryForListening_(l),this.tagForQuery_(l))}return p},c.prototype.createListenerForView_=function(e){var r=this,n=e.getQuery(),a=this.tagForQuery_(n);return{hashFn:function(){return(e.getServerCache()||i.ChildrenNode.EMPTY_NODE).hash()},onComplete:function(e){if(\"ok\"===e)return a?r.applyTaggedListenComplete(n.path,a):r.applyListenComplete(n.path);var i=t.errorForServerCode(e,n);return r.removeEventRegistration(n,null,i)}}},c.makeQueryKey_=function(e){return e.path.toString()+\"$\"+e.queryIdentifier()},c.parseQueryKey_=function(t){var r=t.indexOf(\"$\");return e.assert(-1!==r&&r<t.length-1,\"Bad queryKey.\"),{queryId:t.substr(r+1),path:new y.Path(t.substr(0,r))}},c.prototype.queryKeyForTag_=function(e){return this.tagToQueryMap_[\"_\"+e]},c.prototype.tagForQuery_=function(e){var t=c.makeQueryKey_(e);return n.safeGet(this.queryToTagMap_,t)},c.getNextQueryTag_=function(){return c.nextQueryTag_++},c.prototype.applyTaggedOperation_=function(t,r){var i=this.syncPointTree_.get(t);e.assert(i,\"Missing sync point for query tag that we're tracking\");var n=this.pendingWriteTree_.childWrites(t);return i.applyOperation(r,n,null)},c.prototype.applyOperationToSyncPoints_=function(e){return this.applyOperationHelper_(e,this.syncPointTree_,null,this.pendingWriteTree_.childWrites(y.Path.Empty))},c.prototype.applyOperationHelper_=function(e,t,r,i){if(e.path.isEmpty())return this.applyOperationDescendantsHelper_(e,t,r,i);var n=t.get(y.Path.Empty);null==r&&null!=n&&(r=n.getCompleteServerCache(y.Path.Empty));var a=[],o=e.path.getFront(),p=e.operationForChild(o),s=t.children.get(o);if(s&&p){var u=r?r.getImmediateChild(o):null,l=i.child(o);a=a.concat(this.applyOperationHelper_(p,s,u,l))}return n&&(a=a.concat(n.applyOperation(e,i,r))),a},c.prototype.applyOperationDescendantsHelper_=function(e,t,r,i){var n=this,a=t.get(y.Path.Empty);null==r&&null!=a&&(r=a.getCompleteServerCache(y.Path.Empty));var o=[];return t.children.inorderTraversal(function(t,a){var p=r?r.getImmediateChild(t):null,s=i.child(t),u=e.operationForChild(t);u&&(o=o.concat(n.applyOperationDescendantsHelper_(u,a,p,s)))}),a&&(o=o.concat(a.applyOperation(e,i,r))),o},c.nextQueryTag_=1,c}();exports.SyncTree=c;"},"hash":"ae75d28043b110bdfb3e5680efef7629","cacheData":{"env":{}}}