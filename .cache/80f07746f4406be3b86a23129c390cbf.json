{"dependencies":[{"name":"/Volumes/Work/forks/til.camp/package.json","includedInParent":true,"mtime":1526468255000},{"name":"/Volumes/Work/forks/til.camp/.browserslistrc","includedInParent":true,"mtime":1524300285000},{"name":"/Volumes/Work/forks/til.camp/node_modules/@firebase/database/package.json","includedInParent":true,"mtime":1519337717000},{"name":"../operation/Operation","loc":{"line":18,"column":26}},{"name":"@firebase/util","loc":{"line":19,"column":21}},{"name":"./ChildChangeAccumulator","loc":{"line":20,"column":39}},{"name":"./Change","loc":{"line":21,"column":23}},{"name":"../snap/ChildrenNode","loc":{"line":22,"column":29}},{"name":"../snap/indexes/KeyIndex","loc":{"line":23,"column":25}},{"name":"../util/ImmutableTree","loc":{"line":24,"column":30}},{"name":"../util/Path","loc":{"line":25,"column":21}},{"name":"./CompleteChildSource","loc":{"line":26,"column":36}}],"generated":{"js":"\"use strict\";Object.defineProperty(exports,\"__esModule\",{value:!0});var e=require(\"../operation/Operation\"),t=require(\"@firebase/util\"),r=require(\"./ChildChangeAccumulator\"),i=require(\"./Change\"),a=require(\"../snap/ChildrenNode\"),l=require(\"../snap/indexes/KeyIndex\"),n=require(\"../util/ImmutableTree\"),o=require(\"../util/Path\"),d=require(\"./CompleteChildSource\"),p=function(){return function(e,t){this.viewCache=e,this.changes=t}}();exports.ProcessorResult=p;var s=function(){function s(e){this.filter_=e}return s.prototype.assertIndexed=function(e){t.assert(e.getEventCache().getNode().isIndexed(this.filter_.getIndex()),\"Event snap not indexed\"),t.assert(e.getServerCache().getNode().isIndexed(this.filter_.getIndex()),\"Server snap not indexed\")},s.prototype.applyOperation=function(i,a,l,n){var o,d,h=new r.ChildChangeAccumulator;if(a.type===e.OperationType.OVERWRITE){var v=a;v.source.fromUser?o=this.applyUserOverwrite_(i,v.path,v.snap,l,n,h):(t.assert(v.source.fromServer,\"Unknown source.\"),d=v.source.tagged||i.getServerCache().isFiltered()&&!v.path.isEmpty(),o=this.applyServerOverwrite_(i,v.path,v.snap,l,n,d,h))}else if(a.type===e.OperationType.MERGE){var u=a;u.source.fromUser?o=this.applyUserMerge_(i,u.path,u.children,l,n,h):(t.assert(u.source.fromServer,\"Unknown source.\"),d=u.source.tagged||i.getServerCache().isFiltered(),o=this.applyServerMerge_(i,u.path,u.children,l,n,d,h))}else if(a.type===e.OperationType.ACK_USER_WRITE){var g=a;o=g.revert?this.revertUserWrite_(i,g.path,l,n,h):this.ackUserWrite_(i,g.path,g.affectedTree,l,n,h)}else{if(a.type!==e.OperationType.LISTEN_COMPLETE)throw t.assertionError(\"Unknown operation type: \"+a.type);o=this.listenComplete_(i,a.path,l,h)}var c=h.getChanges();return s.maybeAddValueEvent_(i,o,c),new p(o,c)},s.maybeAddValueEvent_=function(e,t,r){var a=t.getEventCache();if(a.isFullyInitialized()){var l=a.getNode().isLeafNode()||a.getNode().isEmpty(),n=e.getCompleteEventSnap();(r.length>0||!e.getEventCache().isFullyInitialized()||l&&!a.getNode().equals(n)||!a.getNode().getPriority().equals(n.getPriority()))&&r.push(i.Change.valueChange(t.getCompleteEventSnap()))}},s.prototype.generateEventCacheAfterServerEvent_=function(e,r,i,l,n){var o=e.getEventCache();if(null!=i.shadowingWrite(r))return e;var d=void 0,p=void 0;if(r.isEmpty())if(t.assert(e.getServerCache().isFullyInitialized(),\"If change path is empty, we must have complete server data\"),e.getServerCache().isFiltered()){var s=e.getCompleteServerSnap(),h=s instanceof a.ChildrenNode?s:a.ChildrenNode.EMPTY_NODE,v=i.calcCompleteEventChildren(h);d=this.filter_.updateFullNode(e.getEventCache().getNode(),v,n)}else{var u=i.calcCompleteEventCache(e.getCompleteServerSnap());d=this.filter_.updateFullNode(e.getEventCache().getNode(),u,n)}else{var g=r.getFront();if(\".priority\"==g){t.assert(1==r.getLength(),\"Can't have a priority with additional path components\");var c=o.getNode();p=e.getServerCache().getNode();var C=i.calcEventCacheAfterServerOverwrite(r,c,p);d=null!=C?this.filter_.updatePriority(c,C):o.getNode()}else{var f=r.popFront(),y=void 0;if(o.isCompleteForChild(g)){p=e.getServerCache().getNode();var m=i.calcEventCacheAfterServerOverwrite(r,o.getNode(),p);y=null!=m?o.getNode().getImmediateChild(g).updateChild(f,m):o.getNode().getImmediateChild(g)}else y=i.calcCompleteChild(g,e.getServerCache());d=null!=y?this.filter_.updateChild(o.getNode(),g,y,f,l,n):o.getNode()}}return e.updateEventSnap(d,o.isFullyInitialized()||r.isEmpty(),this.filter_.filtersNodes())},s.prototype.applyServerOverwrite_=function(e,t,r,i,a,l,n){var o,p=e.getServerCache(),s=l?this.filter_:this.filter_.getIndexedFilter();if(t.isEmpty())o=s.updateFullNode(p.getNode(),r,null);else if(s.filtersNodes()&&!p.isFiltered()){var h=p.getNode().updateChild(t,r);o=s.updateFullNode(p.getNode(),h,null)}else{var v=t.getFront();if(!p.isCompleteForPath(t)&&t.getLength()>1)return e;var u=t.popFront(),g=p.getNode().getImmediateChild(v).updateChild(u,r);o=\".priority\"==v?s.updatePriority(p.getNode(),g):s.updateChild(p.getNode(),v,g,u,d.NO_COMPLETE_CHILD_SOURCE,null)}var c=e.updateServerSnap(o,p.isFullyInitialized()||t.isEmpty(),s.filtersNodes()),C=new d.WriteTreeCompleteChildSource(i,c,a);return this.generateEventCacheAfterServerEvent_(c,t,i,C,n)},s.prototype.applyUserOverwrite_=function(e,t,r,i,l,n){var o,p,s=e.getEventCache(),h=new d.WriteTreeCompleteChildSource(i,e,l);if(t.isEmpty())p=this.filter_.updateFullNode(e.getEventCache().getNode(),r,n),o=e.updateEventSnap(p,!0,this.filter_.filtersNodes());else{var v=t.getFront();if(\".priority\"===v)p=this.filter_.updatePriority(e.getEventCache().getNode(),r),o=e.updateEventSnap(p,s.isFullyInitialized(),s.isFiltered());else{var u=t.popFront(),g=s.getNode().getImmediateChild(v),c=void 0;if(u.isEmpty())c=r;else{var C=h.getCompleteChild(v);c=null!=C?\".priority\"===u.getBack()&&C.getChild(u.parent()).isEmpty()?C:C.updateChild(u,r):a.ChildrenNode.EMPTY_NODE}if(g.equals(c))o=e;else{var f=this.filter_.updateChild(s.getNode(),v,c,u,h,n);o=e.updateEventSnap(f,s.isFullyInitialized(),this.filter_.filtersNodes())}}}return o},s.cacheHasChild_=function(e,t){return e.getEventCache().isCompleteForChild(t)},s.prototype.applyUserMerge_=function(e,t,r,i,a,l){var n=this,o=e;return r.foreach(function(r,d){var p=t.child(r);s.cacheHasChild_(e,p.getFront())&&(o=n.applyUserOverwrite_(o,p,d,i,a,l))}),r.foreach(function(r,d){var p=t.child(r);s.cacheHasChild_(e,p.getFront())||(o=n.applyUserOverwrite_(o,p,d,i,a,l))}),o},s.prototype.applyMerge_=function(e,t){return t.foreach(function(t,r){e=e.updateChild(t,r)}),e},s.prototype.applyServerMerge_=function(e,t,r,i,a,l,d){var p=this;if(e.getServerCache().getNode().isEmpty()&&!e.getServerCache().isFullyInitialized())return e;var s,h=e;s=t.isEmpty()?r:n.ImmutableTree.Empty.setTree(t,r);var v=e.getServerCache().getNode();return s.children.inorderTraversal(function(t,r){if(v.hasChild(t)){var n=e.getServerCache().getNode().getImmediateChild(t),s=p.applyMerge_(n,r);h=p.applyServerOverwrite_(h,new o.Path(t),s,i,a,l,d)}}),s.children.inorderTraversal(function(t,r){var n=!e.getServerCache().isCompleteForChild(t)&&null==r.value;if(!v.hasChild(t)&&!n){var s=e.getServerCache().getNode().getImmediateChild(t),u=p.applyMerge_(s,r);h=p.applyServerOverwrite_(h,new o.Path(t),u,i,a,l,d)}}),h},s.prototype.ackUserWrite_=function(e,t,r,i,a,d){if(null!=i.shadowingWrite(t))return e;var p=e.getServerCache().isFiltered(),s=e.getServerCache();if(null!=r.value){if(t.isEmpty()&&s.isFullyInitialized()||s.isCompleteForPath(t))return this.applyServerOverwrite_(e,t,s.getNode().getChild(t),i,a,p,d);if(t.isEmpty()){var h=n.ImmutableTree.Empty;return s.getNode().forEachChild(l.KEY_INDEX,function(e,t){h=h.set(new o.Path(e),t)}),this.applyServerMerge_(e,t,h,i,a,p,d)}return e}var v=n.ImmutableTree.Empty;return r.foreach(function(e,r){var i=t.child(e);s.isCompleteForPath(i)&&(v=v.set(e,s.getNode().getChild(i)))}),this.applyServerMerge_(e,t,v,i,a,p,d)},s.prototype.listenComplete_=function(e,t,r,i){var a=e.getServerCache(),l=e.updateServerSnap(a.getNode(),a.isFullyInitialized()||t.isEmpty(),a.isFiltered());return this.generateEventCacheAfterServerEvent_(l,t,r,d.NO_COMPLETE_CHILD_SOURCE,i)},s.prototype.revertUserWrite_=function(e,r,i,l,n){var p;if(null!=i.shadowingWrite(r))return e;var s=new d.WriteTreeCompleteChildSource(i,e,l),h=e.getEventCache().getNode(),v=void 0;if(r.isEmpty()||\".priority\"===r.getFront()){var u=void 0;if(e.getServerCache().isFullyInitialized())u=i.calcCompleteEventCache(e.getCompleteServerSnap());else{var g=e.getServerCache().getNode();t.assert(g instanceof a.ChildrenNode,\"serverChildren would be complete if leaf node\"),u=i.calcCompleteEventChildren(g)}u=u,v=this.filter_.updateFullNode(h,u,n)}else{var c=r.getFront(),C=i.calcCompleteChild(c,e.getServerCache());null==C&&e.getServerCache().isCompleteForChild(c)&&(C=h.getImmediateChild(c)),(v=null!=C?this.filter_.updateChild(h,c,C,r.popFront(),s,n):e.getEventCache().getNode().hasChild(c)?this.filter_.updateChild(h,c,a.ChildrenNode.EMPTY_NODE,r.popFront(),s,n):h).isEmpty()&&e.getServerCache().isFullyInitialized()&&(p=i.calcCompleteEventCache(e.getCompleteServerSnap())).isLeafNode()&&(v=this.filter_.updateFullNode(v,p,n))}return p=e.getServerCache().isFullyInitialized()||null!=i.shadowingWrite(o.Path.Empty),e.updateEventSnap(v,p,this.filter_.filtersNodes())},s}();exports.ViewProcessor=s;"},"hash":"7f2a133bda235717e091f8c7e8da3e96","cacheData":{"env":{}}}